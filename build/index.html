<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
    <link href="http://fonts.googleapis.com/css?family=Rammetto+One" rel="stylesheet" type="text/css">

    <link href="http://fonts.googleapis.com/css?family=Pontano+Sans" rel="stylesheet" type="text/css">

    <title>Robot Librarian</title>
    <meta name="description" content="Stuff about computers in libraries, and libraries in computers
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://robotlibrarian.billdueber.com/">
</head>


  <body>

    <header class="site-header">


  <div class="wrapper">
<div style="float:left;"><img src="/images/robot_alpha.png"></div>

    <a class="site-title" href="/">Robot Librarian<br><span class="site-subtitle">Disclaimer: I'm not actually a robot.</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About Bill</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div id="main">
        <div class="wrapper">
          <div class="home">

  <ul class="post-list">
    
      <li>


        <div class="post-text">
          <h2 class="post-title">
            <a class="post-link" href="/2014/10/schemaless-solr-with-dynamicfield-and-copyfield/">"Schemaless" solr with dynamicField and copyField</a>
          </h2>
          <div class="post-meta">Oct 2, 2014</div>
          <p>[Holy Kamoly, it’s been a long time since I blogged!]</p>

<p>Recent versions of <a href="https://lucene.apache.org/solr/">solr</a> have the option to run in what they call <a href="https://cwiki.apache.org/confluence/display/solr/Schemaless+Mode">“schemaless mode”</a>, wherein fields that aren’t recognized are actually added, automatically, to the schema as real named fields.</p>

<p>I find this intruguing, but it’s not what I’m after right now.</p>

<p>The problem I’m in the first stages of addressing is that my <code>schema.xml</code> is huge mess – very little consistency, no naming conventions dictating what’s stored/indexed, etc. The way people tend to address this is with strict naming conventions (possibly using <a href="https://cwiki.apache.org/confluence/display/solr/Dynamic+Fields">dynamicField</a>s) and judicious use of [copyField](https://cwiki.apache.org/confluence/display/solr/Copying+Fields() directives.</p>

<h2 id="indexed-xor-stored">Indexed XOR Stored?</h2>

<p>The more I thought about it, the more I wondered whether it might be useful to have a <em>strict separation of stored and indexed fields</em>. Indexed fields would be named appropriately, so you know how they’ve been analyzed. And stored fields would have pleasant, human-readable names to make them easy to deal with for consuming applications.</p>

<p>What I <em>think</em> I’d like is a system where:</p>

<ul>
  <li>All stored fields have ‘bare’ names (e.g., ‘title’, not ‘title_t’ or ‘title_s’)</li>
  <li>All indexed fields are typed according to their name (so I know ‘title_t’ is an indexed field of type “text”)</li>
  <li>Separation of stored and indexed fields – a field is either stored or indexed, but not both.</li>
  <li>A “schemaless” setup, where I don’t need to define all (any of?) my fields in my schema and reboot solr when I make a change.</li>
</ul>

<p>To be clear: I’m not sure this is a great way to go as of yet. But I figured out what I think is a good way to do it, should it turn out to be worthwhile.</p>

<h2 id="part-1-dynamic-fields">Part 1: Dynamic Fields</h2>

<p>Solr allows one to define dynamic fields – a field whose type is determined by a glob-match on its name. Instead of explicitly naming your field in your schema, you can do something like:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#070;font-weight:bold">&lt;dynamicField</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">*_is</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">type</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">int</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">indexed</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">stored</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">multiValued</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
</pre></div>
</div>
</div>

<p>…to indicate that any unrecognized field whose name ends in <code>_is</code> will treated as an indexed, stored integer.</p>

<p>Dynamic Field definitions are processed in order of declaration; first one wins. That allows you to define a “default” as the very last <code>dynamicField</code> that matches <em>anything</em> (e.g., <code>*</code>). The <code>schema.xml</code> that ships with Solr suggests that you can use this functionality to just ignore unrecognized fields.</p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#070;font-weight:bold">&lt;dynamicField</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">*</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">type</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ignored</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">multiValued</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
</pre></div>
</div>
</div>

<p>But that gives me an idea.</p>

<h2 id="part-2-copy-fields">Part 2: Copy Fields</h2>

<p>The <code>copyField</code> directive allows you to index the same text into multiple fields (presumably with different analysis chains). Index data into one field, it automatically gets copied into another.</p>

<div><div class="CodeRay">
  <div class="code"><pre>
<span style="color:#070;font-weight:bold">&lt;field</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">type</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">text</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">indexed</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">stored</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
<span style="color:#070;font-weight:bold">&lt;field</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title_l</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">type</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">text_leftanchored</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">indexed</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">stored</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">false</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>

<span style="color:#070;font-weight:bold">&lt;copyField</span> <span style="color:#b48">source</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">dest</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title_l</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>

</pre></div>
</div>
</div>

<p>In this case, even though I only send a <code>title</code>, the indexed field <code>title_l</code> will automatically be created and available for me to search against. Nice.</p>

<h2 id="part-3-copy-field-with-globs">Part 3: Copy Field with globs</h2>

<p>But it gets better. You can have globs (<code>*</code>) in your copyField source or destination attributes.</p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#777">&lt;!-- Copy all text fields (those that end in '_t') into 'keywords' --&gt;</span>
<span style="color:#070;font-weight:bold">&lt;copyField</span> <span style="color:#b48">source</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">*_t</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">dest</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">keywords</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
</pre></div>
</div>
</div>

<p>So that’s nice. But what if you have globs in both the source and the destination? The docs say:</p>

<blockquote>
  <p>The copyField command can use a wildcard (*) character in the dest parameter only if the source parameter contains one as well. copyField uses the matching glob from the source field for the dest field name into which the source content is copied.</p>
</blockquote>

<p>Hmmmmmm….</p>

<h2 id="part-4-putting-it-all-together">Part 4: Putting it all together</h2>

<p>Once I read that, I thought, “Huh. I’m hungry.”</p>

<p>But after lunch, I thought, “Maybe I can do something with this.”</p>

<p>Here’s what I came up with.</p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#070;font-weight:bold">&lt;dynamicField</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">*_t_s</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">type</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">text</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">indexed</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">false</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">stored</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">false</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">multiValued</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
<span style="color:#070;font-weight:bold">&lt;dynamicField</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">*_t</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">type</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">text</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">indexed</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">stored</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">false</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>

<span style="color:#070;font-weight:bold">&lt;copyField</span> <span style="color:#b48">source</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">*_t_s</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">dest</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">*_t</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
<span style="color:#070;font-weight:bold">&lt;copyField</span> <span style="color:#b48">source</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">*_t_s</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">dest</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">*</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>

<span style="color:#777">&lt;!-- The default: a multivalued, stored, non-indexed string --&gt;</span>
<span style="color:#070;font-weight:bold">&lt;dynamicField</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">*</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">type</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">string</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">indexed</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">false</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">stored</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">multiValued</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
</pre></div>
</div>
</div>

<p>Let’s walk through that.</p>

<p>First, there are two <code>dynamicField</code> definitions. The first is a no-op: unstored, unindexed. We use it only for copying. The second is a standard indexed (but not stored) text field.</p>

<p>Then come the <code>copyField</code>s, where we match on the suffixes of the field types.<br />
Finally, we have our default: a stored, unindexed string. (Note that when Solr stores a value, it stores whatever you put into it, not the value after analysis – same as a String does anyway).</p>

<p>Suppose I index an undeclared field called <code>title_t_s</code>:</p>

<ul>
  <li><code>title_t_s</code> matches the first <code>dynamicField</code> declaration. This particular field is, thus ignored (no indexing, no storing) – but it’s available for further processing by the <code>copyField</code>s.</li>
  <li>The first <code>copyField</code> matches, and copies the text into newly-generated field formed by what matched the <code>*</code> in the source field, followed by <code>_t</code>. That’s <code>title</code>, so we get <code>title_t</code>.</li>
  <li>The newly-minted <code>title_t</code> field is also unrecognized, but it matches the <em>second</em> <code>dynamicField</code> and is thus assigned to be an indexed text field.</li>
  <li>Meanwhile, the second <code>copyField</code> <em>also</em> matches our original <code>title_t_s</code>. It uses what matched against the <code>*</code> in the source (<code>title</code>, again) to create a new field just called <code>title</code>.</li>
  <li>Now we have a new field called <code>title</code> not matching any declared field, so it runs down the list of <code>dynamicField</code> definitions until it hits our stopgap at the end: a stored, nonindexed string.</li>
</ul>

<p>So, what we end up with field-wise is:<br />
* <code>title_t_s</code> disappearing into the ether. It’s just gone.<br />
* <code>title_t</code>, an indexed text field<br />
* <code>title</code>, a stored string.</p>

<p>Now I can run searches against <code>title_t</code>, but my document will have a nice stored string in it just called <code>title</code>.</p>

<h2 id="caveats">Caveats</h2>

<p>Depending on how crazy you want to get options-wise (multi-valued or not, termVectors or not, etc.) you can get a combinatorial explosion on the number of <code>dynamicField</code>/<code>copyField</code> sets you need to generate.</p>

<p>You also don’t have <em>any</em> intrinsic documentation of what your index looks like. None. You can’t even look at the indexing code, because it’ll look like you’re sending a document with a field called <code>title_t_s</code> and that field is nowhere to be found.</p>

<p>So, like I said: interesting, but by no means the obvious way to go. Still, I’m sure I’ll have some variant of this in my schema when it comes time for me to reboot the library catalog.</p>


        </div>
      </li>
    
      <li>


        <div class="post-text">
          <h2 class="post-title">
            <a class="post-link" href="/2014/01/yet-another-lc-callnumber-parser.html/">Help me test yet another LC Callnumber parser</a>
          </h2>
          <div class="post-meta">Jan 30, 2014</div>
          <p>Those who have followed this blog and my code for a while know that I have a <a href="http://robotlibrarian.billdueber.com/normalizing-loc-call-numbers-for-sorting/">long</a>, slightly <a href="http://robotlibrarian.billdueber.com/enough-with-the-freakin-lc-call-number-normalization/">sad</a>, and borderline <a href="https://github.com/billdueber/lib.umich.edu-solr-stuff">abusive</a> relationship with Library of Congress call numbers.</p>

<p>They’re a freakin’ nightmare. They just are.</p>

<p>But, based on the premise that Sisyphus was a quitter, I took another stab at it, this time writing a real (PEG-) parser instead of trying to futz with extended regular expressions.</p>

<p>The results, so far, aren’t too bad.</p>

<p>The gem is called <a href="https://github.com/billdueber/lc_callnumber">lc_callnumber</a>, but more importantly, I’ve put together a little heroku app to let you play with it, and then correct any incorrect parses (or tell me that it worked correctly) to build up a test suite.</p>

<p>So…<a href="https://lccparser.herokuapp.com/">Please try to break my LC Callnumber parser</a>!</p>

<p>[Code for the app itself is <a href="https://github.com/billdueber/lccparser">on github</a>; pull requests for both the app and the gem joyously received]</p>


        </div>
      </li>
    
      <li>


        <div class="post-text">
          <h2 class="post-title">
            <a class="post-link" href="/2013/12/new-blog-front-and-back-end.html/">New blog front- and back-end</a>
          </h2>
          <div class="post-meta">Dec 17, 2013</div>
          <p>A while back, <a href="http://dreamhost.com/">Dreamhost</a> had some problems and my blog and assorted other websites I help keep track of went down.</p>

<p>For more than two weeks.</p>

<p>Now, I understand that crap happens. And I understand that sometimes lots of things happen at once. But fundamentally, their infrastructure is such that they could lose everything on a machine and be unable to get it back for more than two weeks. I’m not a mathematician, but that’s not “five-nine” service.</p>

<p>So, I decided to start hunting around for another provider. And then I got distracted by the idea that maybe having my blog in <a href="http://wordpress.org">Wordpress</a> was more trouble than it was worth. There’s something to be said for simplicity, especially since all I really wanted to do is throw up posts written in markdown with code samples.</p>

<p>I got a few pointers toward using <a href="http://middlemanapp.com/">middleman</a>, a pre-processor that takes in almost anything and produces regular css/html. Between that and <a href="http://disqus.com/">Disqus</a> for the comments, well, this just seems easier. And now that I’ve put in the effort, it’ll be easier to actually get blog posts up, most importantly, move it over when I find a new hosting provider.</p>

<p>Feel free to tell me how ugly it is and suggest improvements. I have the design skills of a one-eyed poodle.</p>


        </div>
      </li>
    
      <li>


        <div class="post-text">
          <h2 class="post-title">
            <a class="post-link" href="/2013/10/announcing-traject-indexing-software/">Announcing "traject" indexing software</a>
          </h2>
          <div class="post-meta">Oct 14, 2013</div>
          <p>[Over the next few days I’ll be writing a series of posts that highlight a new indexing solution by Jonathan Rochkind and myself called <code>traject</code> that we’re using to index MARC data into Solr. This is the introduction.]</p>

<p>Wow. Six months since I posted here. What have I been doing?</p>

<p>Well, mostly parenting, but in the last few weeks I was lucky enough to get on board with a project started by <a href="http://bibwild.wordpress.com/">Jonathan Rochkind</a> for a new JRuby-based tool optimized for indexing MARC data into solr. You know, kinda like solrmarc, but JRuby.</p>

<h3 id="whats-it-look-like">What’s it look like?</h3>

<p>I encourage you to take a look at a <a href="https://github.com/traject-project/traject_sample">little sample setup</a> I put together for instructional purposes. It’s based on the HathiTrust catalog indexing scheme and shows off about 85% of what <code>traject</code> can do. Clone it and go through the README and the two indexing files to get a taste of how things are put together.</p>

<p>Real quickly, though, here’s a sample configuration file to pull out the ID, title, and authors (if any) out of a file of MARC records and send them to a file as JSON object, one record per line (i.e., newline-delimited JSON)</p>

<div><div class="CodeRay">
  <div class="code"><pre>
<span style="color:#777"># we'll pretend this file is called 'sample.rb'</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">traject</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">traject/marc_reader</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">traject/json_writer</span><span style="color:#710">'</span></span>


<span style="color:#777"># It's just ruby, so I can have comments!</span>
<span style="color:#777"># Here we set up which reader/writer to use and so on</span>
settings <span style="color:#080;font-weight:bold">do</span>
  provide <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">reader_class_name</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Traject::MarcReader</span><span style="color:#710">&quot;</span></span>
  provide <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">writer_class_name</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Traject::JsonWriter</span><span style="color:#710">&quot;</span></span>
  provide <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">output_file</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">basics.ndj</span><span style="color:#710">&quot;</span></span>
  provide <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">processing_thread_pool</span><span style="color:#710">'</span></span>, <span style="color:#00D">3</span>
<span style="color:#080;font-weight:bold">end</span>


<span style="color:#777"># It's *still* just ruby, so I can declare a variable!</span>
idfield = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">001</span><span style="color:#710">'</span></span>

<span style="color:#777"># ...and then use it to find the ID</span>
to_field <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>, extract_marc(idfield, <span style="color:#A60">:first</span> =&gt; <span style="color:#069">true</span>)

<span style="color:#777"># Now the other data</span>
to_field <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title</span><span style="color:#710">&quot;</span></span>, extract_marc(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">245</span><span style="color:#710">'</span></span>)
to_field <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">author</span><span style="color:#710">&quot;</span></span>, extract_marc(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">100abcd:110abcd:111abc</span><span style="color:#710">'</span></span>)


<span style="color:#777"># You'd run this as:</span>
<span style="color:#777">#    traject -c sample.rb myfile.mrc</span>


</pre></div>
</div>
</div>

<p>That’s simplistic, of course, but it should drive home the point that we strove to make sure traject <em>makes the easy stuff easy</em>.  For a more complex example, look at <a href="https://github.com/traject-project/traject_sample/blob/master/index.rb">the heavily-annotated index.rb file</a> in the sample project.</p>

<h3 id="why-use-or-move-to-traject">Why use (or move to) traject?</h3>

<p>First off, you can and should look at <a href="http://bibwild.wordpress.com/2013/10/14/traject-marc-solr-indexer-release/">the annoucement</a> and/or <a href="https://github.com/traject-project/traject/">the README</a> for a longer answer, but I’ll tell you why <em>I</em> use <code>traject</code> in one word:</p>

<p>Flexibility.</p>

<p>After a year or so of struggling with <a href="https://code.google.com/p/solrmarc/">solrmarc</a> (often due to my lack of Java-fu), and then even more years after that using my own, home-grown <a href="https://github.com/billdueber/marc2solr">marc2solr</a>, the things I most wanted were the ability to decouple the various components from each other, rely on code instead of configuration, and basically just know that I can up the complexity of my code without paying an enormous price.</p>

<p>I’m fast wtih Ruby. And the architecture of <code>traject</code> allows me to easily build and test my transformations in isolation, with tools I’m good with, with debugging output that’s easy to read or process by machine or inspection.</p>

<h3 id="what-does-it-have-out-of-the-box">What does it have out of the box?</h3>

<p>One advantage <code>traject</code> has that my previous system didn’t is, well, years of struggling with my previous system. I’ve learned a lot about what I need, what needs to be easy, and how I want to think about indexing.</p>

<p>The nature of <code>traject</code> is that “a reader” sends “a record” to “an indexer” which produces a key=&gt;value hash and sends <em>that</em> to “a writer.” Obviously, this is a pretty abstract setup; it’s not hard to see how it could be used for all sorts of transformations (e.g., I’m already thinking about a simple gem that would provide macros to index CSV or tab-delmited files into Solr. Or maybe going to/from a database).</p>

<p>But Jonathan and I are, mostly, stuck dealing with MARC data and Solr. So here’s what we get:</p>

<p><strong>Readers</strong>: MARC readers for MARC21 binary and MARC-XML based on both ruby-marc and marc4j (the latter allowing you to deal with encoding transformations and the like). An NDJ reader (for one marc-in-json structure per line in a file – that’s what we use in for the HathiTrust). And we’ve already got a couple gems for people with other needs: <a href="https://github.com/traject-project/traject_alephsequential_reader">traject_alephsequential_reader</a> for those that need to deal with AlephSequential, and Jonathan’s new <a href="https://github.com/jrochkind/traject_horizon">horizon reader</a> for efficiently pulling records right out of your Horizon ILS, if you happen to run one.</p>

<p><strong>Transforming Macros</strong>: A traject indexing step is just a well-formed ruby block (or lambda), which makes writing macros ridiculously easy. Traject ships with most of what you’d commonly need to deal with MARC: extracting data based on tag/subfield/indicators (or substring of a fixed field), dealing with non-filing characters, automatically dealing with 880 linked fields. Mucking with publication dates. Dealing with languages, formats, etc. And, of course, doing it all with multiple threads, because who wants to see all those lovely cores go to waste?</p>

<p><strong>Writers</strong>: Of course, you can write to solr, using the excellent <code>solrj</code> java library. And you can do it in multiple threads, to keep things fast. But there’s also the <code>DebugWriter</code> to spit stuff out in a human-readable format, and the <code>JsonWriter</code> mentioned above to spit stuff out in a <em>machine</em>-readable format. And building your own writer is literally just a couple methods.</p>

<h3 id="how-do-i-get-a-taste">How do I get a taste?</h3>

<p>Like I said, clone and play with <a href="https://github.com/traject-project/traject_sample">the sample project</a>. And ask me questions, either here or via email. After years of being the only person running my indexing software, I’m anxious to try to build up a community around <code>traject</code>.</p>


        </div>
      </li>
    
      <li>


        <div class="post-text">
          <h2 class="post-title">
            <a class="post-link" href="/2013/04/come-work-at-the-university-of-michigan/">Come work at the University of Michigan</a>
          </h2>
          <div class="post-meta">Apr 18, 2013</div>
          <p>The Library has three UX positions available right now – interface designer, interface developer, and a web content strategist.</p>

<p>Come join me at what is easily the best place I’ve ever worked! <a href="http://userslib.com/2013/04/16/ux-and-web-systems-job-postings-at-the-university-of-michigan-library/">Full details are over at Suz’s blog</a>.</p>


        </div>
      </li>
    
      <li>


        <div class="post-text">
          <h2 class="post-title">
            <a class="post-link" href="/2013/02/please-dont-return-your-books/">Please: don't return your books</a>
          </h2>
          <div class="post-meta">Feb 12, 2013</div>
          <p>So, I’m at <a href="http://code4lib.org/conference/2013">code4lib 2013</a> right now, where side conversations and informal exchanges tend to be the most interesting part.</p>

<p>Last night I had an conversation with the inimitable <a href="https://twitter.com/mbklein">Michael B. Klein</a>, and after complaining about faculty members that keep books out for <em>decades</em> at a time, we ended up asking a simple question:</p>

<blockquote>
  <p>How much more shelving would we need if everyone returned their books?</p>
</blockquote>

<p>Assuming we could get them all checked in and such, well, where would we put them?</p>

<p>I’m looking at this in the simplest, most conservative way possible:</p>

<ul>
  <li>Assume they’re all paperbacks, so we don’t worry about how thick a cover is (cover width = 0)</li>
  <li>Assume items for which we don’t have page count information are “average”</li>
</ul>

<h3 id="starting-data">Starting data</h3>

<p>What’s my current situation at Michigan?</p>

<ul>
  <li>Total bibs: about 10M (but that includes a bunch of HathiTrust items and other electronic-only items that could never be checked out)</li>
  <li>Total items checked out right now: 162,080</li>
</ul>

<p>The first problem I run into is that I don’t know how many pages are in a given book. Well, in theory I can look in MARC field 300$a, and it will tell me.</p>

<h3 id="finding-the-number-of-pages-in-a-book">Finding the number of pages in a book</h3>

<p>I went through a recent dump of all our records and pulled out page counts from the 300 (those that matched the regular expression $$a\d+\s+[pP].).</p>

<p>Problem solved, right? Well, kind of</p>

<ul>
  <li>3,085,433 total bibs with page count data (about 30%)</li>
  <li>40,872 checked out items with page count data (about 25%)</li>
</ul>

<p>OK, so I don’t have data for everything. Plus, some of those are multi-volume works that list the total page count, even though only a single volume may be checked out.</p>

<p>We’ll have to drop down into statistics:</p>

<ul>
  <li>Average number of pages in a checked-out item: 270</li>
  <li>Median number of pages in a checked-out item: 244</li>
</ul>

<p>The median is lower, so we’ll go with that. Being conservative, remember?</p>

<h3 id="bringing-it-all-together">Bringing it all together</h3>

<p>Obviously we need to make a lot of assumptions.</p>

<ul>
  <li>All paperbacks (== no space allowance for covers)</li>
  <li>244 pages per item (the median of checked out items for which we have data)</li>
  <li>Pages = 244 * 162,080 = 39,547,520 pages</li>
</ul>

<h3 id="sowhats-the-damage">So…what’s the damage?</h3>

<p>But how to do the calculation?</p>

<p>It turns out that simply googling <a href="https://www.google.com/search?num=30&amp;hl=en&amp;safe=off&amp;tbo=d&amp;noj=1&amp;site=webhp&amp;source=hp&amp;q=book+spine+width+calculator&amp;oq=book+spine+widt">book spine width calculator</a> a few come up.</p>

<p>I picked one and input 39,547,520 pages and assumed 50lb paper (the lightest paper in the tool).</p>

<p><strong>Total width: 77,241.25 inches, or 6437 feet, or 1.22 miles</strong></p>

<h3 id="miles">1.22 miles???</h3>

<p>Well, we had a lot of assumptions,but most of them were pretty conservative. And I have no idea if the book spine calculator is at all accurate.</p>

<p>But…it’s gonna be a big number no matter what. Add in that many of them are hardcover, and this seems like a pretty good guess at a lower end.</p>

<h3 id="what-is-this-good-for-again">What is this good for again?</h3>

<p>Oh, nothing at all. Just a little fun while I’m at code4lib.</p>

<h3 id="next-steps">Next steps</h3>

<p>Well, the best next step would be to walk away. This is a huge waste of time.</p>

<p>But…we could look in the 020s for a hint of whether it’s hardcover or paperback (which is <a href="http://robotlibrarian.billdueber.com/isbn-parenthetical-notes-bad-marc-data-1/">really hard</a>. And maybe try to figure out if multiple volumes of a multi-volume work are all checked out and take that into account.</p>

<p>But really: this is enough for me. Whether Michael wants to pursue it further on his own, well, that’s up to him.</p>


        </div>
      </li>
    
      <li>


        <div class="post-text">
          <h2 class="post-title">
            <a class="post-link" href="/2012/03/boosting-on-exactish-anchored-phrase-matching-in-solr-sst-4/">Boosting on Exactish (anchored) phrase matching in Solr: (SST #4)</a>
          </h2>
          <div class="post-meta">Mar 19, 2012</div>
          <blockquote>
  <p>Check out <a href="http://robotlibrarian.billdueber.com/stupid-solr-tricks-introduction/">introduction to the Stupid Solr Tricks series</a> if you’re just joining us.]</p>
</blockquote>

<p><em>Exact</em> matching in Solr is easy. Use the default <em>string</em> type: all it does is, essentially, exact phrase matching. <em>string</em> is a great type for faceted values, where the only way we expect to search the index is via text pulled from the index itself. Query the index to get a value: use that value to re-query the index. Simple and self-contained.</p>

<p>But much of the time, we don’t want exact matching. We want <em>exactish</em> matching. You know, where things are exactly the same <em>except</em>. Except for case, or punctuation, or how much whitespace is between tokens. Maybe do some unicode folding, or stemming.</p>

<p>Essentially, we want to reward users (via high relevancy) for getting <em>really close</em>. If someone types in a full title, but misses a colon, well, let’s go  ahead and assume they want that particular item.</p>

<h3 id="exactish-matching-vs-phrase-matching"><em>Exactish</em> matching vs phrase matching</h3>

<p>Phrase matching in Solr does a great job, but fails those of us generating super-complex queries where we want to provide awesome service for those users doing <em>known-item queries</em>. If someone puts in the exact(ish) title, or the exact(ish) subject, well, those items should float to the top.</p>

<p>Solr’s default phrase matching (via, say, the <code>pf</code> param in dismax or just putting your query in quotes) doesn’t differentiate between a phrase that matches the whole target string and only part of that target string. For this, we’ll need a decent text <code>fieldtype</code> and a way to “anchor” the search to both ends of the target string.</p>

<h3 id="our-goals">Our goals</h3>

<p>We’re shooting for:</p>

<ul>
  <li>A useful text type that we can use all over the place</li>
  <li>A phrase match against that field that will match any portion of the target text. Solr already does this – that’s a normal Solr phrase search.</li>
  <li>A “fully anchored” text type that will only phrase match if the query string exactishly-matches the whole field. We’ll phrase-search on this field and boost it way up.</li>
  <li>And, what the heck, a left-anchored version that will exactish match a phrase only at the start of a field. We’ll boost this one up a bit less.</li>
</ul>

<h3 id="follow-along-at-home">Follow along at home</h3>

<p>Go ahead and clone the <a href="https://billdueber@github.com/billdueber/solr_stupid_tricks">github repo</a> I’ve been using  if you haven’t already and let’s dig in.</p>

<div><div class="CodeRay">
  <div class="code"><pre>
cd solr_stupid_tricks
git pull origin master
git fetch --all
git checkout SST4
java -jar start.jar &amp;

</pre></div>
</div>
</div>

<p>There are some additions to the <code>schema.xml</code> file; let’s take a look!</p>

<h3 id="step-1-get-a-decent-text-type">Step 1: get a decent text type</h3>

<p>The recent-nighty of Solr 3.x we’re using has a great tokenizer in ICUTokenizerFactory, which does “the right thing” across a whole host of languages.</p>

<div><div class="CodeRay">
  <div class="code"><pre>
<span style="color:#070;font-weight:bold">&lt;fieldtype</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">text</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.TextField</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">positionIncrementGap</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">1000</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;analyzer&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;tokenizer</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.ICUTokenizerFactory</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.ICUFoldingFilterFactory</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.SynonymFilterFactory</span><span style="color:#710">&quot;</span></span>
              <span style="color:#b48">synonyms</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">syn.txt</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">ignoreCase</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">expand</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">false</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
<span style="color:#777">&lt;!-- &lt;filter class=&quot;solr.WordDelimiterFilterFactory&quot;
             generateWordParts=&quot;1&quot; generateNumberParts=&quot;1&quot;
             catenateWords=&quot;1&quot; catenateNumbers=&quot;1&quot; catenateAll=&quot;0&quot;/&gt; --&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.CJKWidthFilterFactory</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.CJKBigramFilterFactory</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/analyzer&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/fieldtype&gt;</span>

</pre></div>
</div>
</div>

<p>Let’s take it bit by bit:</p>

<ul>
  <li>Obviously, start with the <code>ICUTokenizer</code> with a large positionIncrementGap so we can do some of the tricks we talked about <a href="http://robotlibrarian.billdueber.com/requiringpreferring-searches-that-dont-span-multiple-values-sst-3/">last time</a></li>
  <li>Next, we get one-stop shopping with the <code>ICUFoldingFilterFactory</code>. It provides all of the following:
    <ul>
      <li>NFKC normalization (precomosing),</li>
      <li>Unicode case folding (i.e., lowercasing)</li>
      <li>search term folding (removing accents, etc).</li>
    </ul>
  </li>
  <li>Push in synonyms if you have any</li>
  <li>Uncomment the <code>WordDelimiterFilterFactory</code> if you want to. I’m going to try to avoid it, since it messes with the number of tokens midstream and I worry about the effect on dismax and its <code>mm</code> parameter as <a href="http://bibwild.wordpress.com/2011/06/15/more-dismax-gotchas-varying-field-analysis-and-mm/">explained so excellently by Jonathan Rochkind</a></li>
  <li><a href="http://www.hathitrust.org/blogs/large-scale-search/multilingual-issues-part-1-word-segmentation">Dealing with CJK (Chinese, Japanese, Korean) is hard</a>. The CJK filters process those languages and provide overlapping bigrams so searching isn’t (I’m told) quite as painful. (I really, really recommend the above link for a great overview by Tom Burton-West).</li>
</ul>

<h3 id="step-2-set-up-parallel-text-types-that-anchor-phrase-matches-to-one-or-both-ends">Step 2: Set up parallel text types that anchor phrase matches to one or both ends</h3>

<p>We’re going to use something new: a <code>charFilter</code>. This differs from a normal filter in that it affects the input string before tokenization.</p>

<p>Here’s the trick. We’re going to add anchoring text (I chose just ‘AAAA’ at the front and ‘ZZZZ’ at the end) to the normal text type, just by adding a simple charfilter.</p>

<div><div class="CodeRay">
  <div class="code"><pre>
<span style="color:#070;font-weight:bold">&lt;fieldtype</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">text_lr</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.TextField</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">positionIncrementGap</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">1000</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;analyzer&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;charFilter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.PatternReplaceCharFilterFactory</span><span style="color:#710">&quot;</span></span>
      <span style="color:#b48">pattern</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">^(.*)$</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">replacement</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">AAAA $1 ZZZZ</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;tokenizer</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.ICUTokenizerFactory</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.ICUFoldingFilterFactory</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.SynonymFilterFactory</span><span style="color:#710">&quot;</span></span>
              <span style="color:#b48">synonyms</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">syn.txt</span><span style="color:#710">&quot;</span></span>
              <span style="color:#b48">ignoreCase</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">expand</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">false</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.CJKWidthFilterFactory</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.CJKBigramFilterFactory</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/analyzer&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/fieldtype&gt;</span>


</pre></div>
</div>
</div>

<p>Note that this charFilter actually adds two new tokens (‘AAAA’ and ‘ZZZZ’) to your token stream on both index and query. How does this help us?</p>

<p>Let’s look at indexing <code>Mister Blue Sky</code> in a normal text field. A normal solr phrase query <code>q="Blue Sky"</code> will match on that value, because the query phrase is fully contained in the indexed phrase.</p>

<p>But what happens if we index into a <code>text_lr</code> field?</p>

<ul>
  <li>Indexing <code>Mister Blue Sky</code> becomes <code>aaaa mister blue sky zzzz</code></li>
  <li>Search terms <code>blue sky</code> becomes <code>aaaa blue sky zzzz</code></li>
  <li>Phrase searching will then compare the two transformed values using normal Solr rules, <em>find the the latter is not fully contained in the former as a phrase</em>, and give up.</li>
</ul>

<p>Be careful, though. That ‘aaaa’ and ‘zzzz’ are there just as if you’d typed them in. Thus every indexed value has the tokens ‘aaaa’ and ‘zzzz’, and every query will, in effect, include a query for ‘aaaa’ or ‘zzzz’ (depending on your <code>mm</code> settings).</p>

<p>That means that <strong>any non-phrase query will match every field that uses this fieldtype</strong>, and it will also mess with token counts with respect to your <code>mm</code> parameter. For those reasons, <em>only ever use anchored fieldtypes for phrase queries when you want exactish matches</em>.</p>

<p>By adding only one of ‘AAAA’ or ‘ZZZZ’, we can have left-anchored and right-anchored searches as well. See <a href="https://github.com/billdueber/solr_stupid_tricks/blob/SST4/solr/conf/schema.xml">the schema.xml</a> for these definitions.</p>

<h3 id="try-it-out">Try it out!</h3>

<p>Let’s take a small set of new documents:</p>

<div><div class="CodeRay">
  <div class="code"><pre>
[
  {
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">1</span><span style="color:#710">&quot;</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title</span><span style="color:#710">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">The Monkees: Pleasant Valley Never</span><span style="color:#710">&quot;</span></span>
  },
  {
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">2</span><span style="color:#710">&quot;</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title</span><span style="color:#710">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">The Monkees</span><span style="color:#710">&quot;</span></span>
  },
  {
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">3</span><span style="color:#710">&quot;</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title</span><span style="color:#710">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Meet the Monkees</span><span style="color:#710">&quot;</span></span>
  },
  {
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">4</span><span style="color:#710">&quot;</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title</span><span style="color:#710">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Corportate boy bands through the ages</span><span style="color:#710">&quot;</span></span>
  }
]

</pre></div>
</div>
</div>

<p>We have copyFields set up to copy the title field to both a fully-anchored field (<code>text_exact</code>) and a left-anchored field (<code>text_l</code>).</p>

<div><div class="CodeRay">
  <div class="code"><pre>
  <span style="color:#070;font-weight:bold">&lt;copyField</span> <span style="color:#b48">source</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">dest</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title_exact</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;copyField</span> <span style="color:#b48">source</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">dest</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">title_l</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>

</pre></div>
</div>
</div>

<p>If you’re following at home, clear out your solr and index them:</p>

<div><div class="CodeRay">
  <div class="code"><pre>
cd exampledocs
 ./reset_and_index_json.sh exactish.json

</pre></div>
</div>
</div>

<p>We’ll now run three dismax queries, all of which use the search terms <code>the monkees</code>. Watch what happens to the score as we change things.</p>

<ul>
  <li>First, <code>qf=title, pf=title^2</code>. This will match the three Monkees documents, and then boost <em>all</em> of them because they all contain the phrase “the monkees” in the title.</li>
  <li>Second, <code>qf=title, pf=title_exact^10 title^2</code>. These will match the Monkees documents, and then give a huge boost to the one with the exact match.</li>
  <li>Finally, <code>qf=title, pf=title_exact^10 title_l^5 title^2</code>. There you’ll see the score for the exact title match go way up (relatively speaking, of course), and document 1 go up quite a bit (because it begins with the phrase “The Monkees”).</li>
</ul>

<p>You can run all three queries as:</p>

<div><div class="CodeRay">
  <div class="code"><pre>
cd ruby
ruby browse.rb exactish_query.rb
# or ruby browse.rb exactish_query.rb json|xml|csv to get different output type

</pre></div>
</div>
</div>

<p>[BTW, <code>browse.rb</code> will now take an array of queries to run in a single file.]</p>

<p>Tah Dah! You’ve successfully boosted the exatish match, and the left-anchored exactish match. Your known-item-searchers will thank you.</p>

<p>You may want to take a look at <code>exactish_query.rb</code> to see what’s going on.</p>

<h3 id="to-sum-up">To sum up</h3>

<ul>
  <li>Your <code>schema.xml</code> now contains a decent text type and three variants for anchoring phrase searches left, right, and full (exactish)</li>
  <li>The anchored text fields should NOT NOT NOT be searched against by anything other than a single phrase (which means they’re very useful in the <code>pf</code> param of a dismax search). A non-phrase search will trivially match <em>every single document</em>, so, you know, avoid that.</li>
  <li>You now have a set of tools (field types, copyField directives, phrase search) that can be used to provide higher boosts to exactish matches and left-anchored exactish phrase matches.</li>
</ul>


        </div>
      </li>
    
      <li>


        <div class="post-text">
          <h2 class="post-title">
            <a class="post-link" href="/2012/03/requiringpreferring-searches-that-dont-span-multiple-values-sst-3/">Requiring/Preferring searches that don't span multiple values (SST #3)</a>
          </h2>
          <div class="post-meta">Mar 9, 2012</div>
          <blockquote>
  <p>Check out <a href="http://robotlibrarian.billdueber.com/stupid-solr-tricks-introduction/">introduction to the Stupid Solr Tricks series</a> if you’re just joining us.]</p>
</blockquote>

<h3 id="solr-and-multivalued-fields">Solr and multiValued fields</h3>

<p>Here’s another thing you need to understand about Solr: it doesn’t really have fields that can take multiple values.</p>

<p>“But Bill,” you’re saying, “sure it does. I mean, hell, it even has a ‘multiValued’ parameter.”</p>

<p>First off: watch your language.</p>

<p>Second off: are you <em>sure</em>?</p>

<p>Let’s do a quick test. Look at the following documents</p>

<div><div class="CodeRay">
  <div class="code"><pre>exampledocs/names.json
[
  {
    <span style="color:#606"><span style="color:#404">&quot;</span><span>id</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">1</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>title</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">The Monkees</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>name_text</span><span style="color:#404">&quot;</span></span>: [<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Peter Tork</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Mike Nesmith</span><span style="color:#710">&quot;</span></span>,
                  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Micky Dolenz</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Davy Thomas Jones</span><span style="color:#710">&quot;</span></span>]
  },
  {
    <span style="color:#606"><span style="color:#404">&quot;</span><span>id</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">2</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>title</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Heros of the Wild West</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>name_text</span><span style="color:#404">&quot;</span></span>: [<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Buck Jones</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Davy Crockett</span><span style="color:#710">&quot;</span></span>]
  }
]

</pre></div>
</div>
</div>

<p>Question: what do you get when you run this query against those two documents?</p>

<div><div class="CodeRay">
  <div class="code"><pre>ruby/names_query.rb
{
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">fl</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">score, *</span><span style="color:#710">'</span></span>,
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">defType</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">dismax</span><span style="color:#710">'</span></span>,
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">wt</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">csv</span><span style="color:#710">'</span></span>,
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">qf</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name_text</span><span style="color:#710">'</span></span>,
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">q</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">davy jones</span><span style="color:#710">'</span></span>   <span style="color:#777"># Poor guy just died. So young. So short.</span>
}

</pre></div>
</div>
</div>

<p>See how I threw the <em>wt=csv</em> in there? Check out <a href="http://lucene.apache.org/solr/api/org/apache/solr/response/QueryResponseWriter.html">all the query response formats</a> if you’re interested, but really all you’ll use is <code>standard</code> (XML), <code>json</code>, or <code>csv</code> unless you’re rolling your own in some way.</p>

<p>I’ve updated <code>ruby/browse.rb</code> to allow a second argument of the type of output you want. You can now do <code>ruby browse.rb jsonfile [json|csv|standard|xml]</code></p>

<h3 id="following-along-at-home">Following along at home?</h3>

<p>If so, let’s go ahead and index these document and run the query.</p>

<div><div class="CodeRay">
  <div class="code"><pre>Play along at home
cd solr_stupid_tricks
git pull origin master
git fetch --all
git checkout SST3 # I've started tagging the repo for these posts
# ignore warning about &quot;detached HEAD&quot;
java -jar start.jar &amp;
cd exampledocs
 ./reset_and_index_json.sh names.json
 cd ../ruby
 ruby browse.rb names_query.rb

</pre></div>
</div>
</div>

<p>Here’s the scores that I get:</p>

<div><div class="CodeRay">
  <div class="code"><pre>Return from Solr
  id,title,name_text,score
  2,Heros of the Wild West,&quot;Buck Jones,Davy Crockett&quot;,0.42039964
  1,The Monkees,&quot;Peter Tork,Mike Nesmith,Micky Dolenz,Davy Thomas Jones&quot;,0.26274976

</pre></div>
</div>
</div>

<p>Check out that last column. The query was <em>davy jones</em>. Document #1 contains a name that has both those terms, but document #2 (which has both terms, but in different names) gets a higher score.</p>

<h3 id="the-relevance-ranking-seemswrong">The relevance ranking seems…wrong</h3>

<p>While it <em>looks</em> like we added four separate names to the <code>name_text</code> field in our first document, Solr doesn’t see it that way. Solr treats those four poor Monkees as if they had one long name.</p>

<p>Then it finds all the documents that match the query (both of our documents match) and figures out which is a better match by assigning a score.</p>

<p>In this case, while both document have both query terms, the field in the second document is <em>shorter</em>. Which means that, essentially, a <em>higher percentage of the terms in the field value match the given  query terms</em>. In Solr’s mind, that makes it a better match, and the shorter document shows up first.</p>

<p>Solr doesn’t automatically give more weight to the recently-dead Monkee because internally it doesn’t care that you’re thinking of those values as four separate names. It just concatenates them together and indexes them.</p>

<p>This is <strong>not</strong>, for most people, expected behavior.</p>

<h3 id="phrase-slop">Phrase slop</h3>

<p>Part of what’s going on here is that we haven’t told Solr that it should care how close together the terms are.</p>

<p>One way to do that is to use a phrase query by throwing quotes around the terms</p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#036;font-weight:bold">Put</span> double-quotes around it to make it a phrase query
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">q</span><span style="color:#710">&quot;</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">&quot;Davy Jones&quot;</span><span style="color:#710">'</span></span>

</pre></div>
</div>
</div>

<p>…but that won’t find anything, because <em>Davy</em> and <em>Jones</em> aren’t right next to each other in our document.</p>

<p>Solr does allow a phrase query to be “sloppy”, though – basically saying that instead of being right next to each other, the terms need to be within a certain number of tokens of each other.</p>

<p>For that, we’ll tell solr to search against certain fields (<code>pf</code>) treating the query as a phrase, and allow a little slop (<code>ps</code>) as well.</p>

<div><div class="CodeRay">
  <div class="code"><pre>ruby/names_sloppy_query.rb
  {
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">fl</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">score, *</span><span style="color:#710">'</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">defType</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">dismax</span><span style="color:#710">'</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">wt</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">csv</span><span style="color:#710">'</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">q</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">davy jones</span><span style="color:#710">'</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">qf</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name_text</span><span style="color:#710">'</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">pf</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name_text^10</span><span style="color:#710">'</span></span>, <span style="color:#777"># search this field as a phrase</span>
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">ps</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">4</span><span style="color:#710">'</span></span> <span style="color:#777"># allow 'phrase' to mean 'within 4 tokens of each other'</span>
  }  

</pre></div>
</div>
</div>

<p>That gets us something more expected.</p>

<div><div class="CodeRay">
  <div class="code"><pre>
  id,title,name_text,score
  1,The Monkees,&quot;Peter Tork,Mike Nesmith,Micky Dolenz,Davy Thomas Jones&quot;,0.2806283
  2,Heros of the Wild West,&quot;Buck Jones,Davy Crockett&quot;,0.029652705

</pre></div>
</div>
</div>

<h3 id="enter-positionincrementgap">Enter <code>positionIncrementGap</code></h3>

<p>OK. Now that we have the concept of “slop”, one of those mystery <code>fieldtype</code> parameters makes sense: <code>positionIncrementGap</code>. Basically, a <code>positionIncrementGap</code> of 1000 means <em>When computing slop, pretend there are 1000 tokens between the entries in a multValued field</em>.</p>

<p>A sloppy phrase search, then, will only find (and thus boost) the phrase if (a) the tokens are in the same entry for a multiValued field, and (b) your slop value is less than your <code>positionIncrementGap</code>.</p>

<p>All you have to do is use the <code>pf</code> and <code>ps</code> parameters and you’re set.</p>

<p>Note that this should be telling you two things:</p>

<ul>
  <li><strong>Always use the same positionIncrementGap for your multiValued fields</strong></li>
  <li><strong>Make it a number much larger than the maximum number of tokens you expect to ever have in a field.</strong></li>
</ul>

<p>Note that a large <code>positionIncrementGap</code> doesn’t <em>actually</em> put 1000 tokens in there – a large value doesn’t affect processing time or your index size or anything.</p>

<h3 id="but-im-already-using-the-pf-parameter">But I’m already using the <code>pf</code> parameter!</h3>

<p>Slop is great when you want it. But I don’t always want to use slop. Slop of 4 makes the phrase “<em>Sex in the City</em>” be treated exactly the same as “<em>In the Sex City</em>”. If someone puts in an exact title, I want to reward them for that query by floating the exact match to the top, and slop prevents me from doing so.</p>

<p>[<em>Forshadowing</em>: We’ll talk about exact-ish matches in a few days.]</p>

<p>OK, so we can’t just appropriate the <code>pf</code>/<code>ps</code> parameters and and push the slop value up all the time – that cripples our ability to create the query boost structure we want.</p>

<h3 id="query-slop">Query slop</h3>

<p>So, dismax (and its cousin edismax) have an analogous parameter that affects only <em>phrases within</em> the normal query: <code>qs</code>.</p>

<p><code>qs</code> is a dismax param that affects <em>query slop</em> – how much slop to allow in phrases within the query, much like the <code>ps</code> param.</p>

<p>The query</p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#036;font-weight:bold">A</span> three-token query
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">q</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Bill &quot;The Weasel&quot; Dueber</span><span style="color:#710">'</span></span>

</pre></div>
</div>
</div>

<p>…has three tokens, the second of which (<em>“The Weasel”</em>) is a phrase. It’s that phrase token that is affected by query slop.</p>

<p>OK. So it affects only the phrases in the normal query. But…suppose we just force the <em>entire</em> query to be one big phrase? That’ll get us somewhere!</p>

<p>We just need to do the following:</p>

<ul>
  <li>Create a boost query that uses the same fields as the regular query</li>
  <li>…but treats all the query terms as one big phrase</li>
  <li>…and give it a query slop of one less that the <code>positionIncrementGap</code> in our field type definition (in my case, 999)</li>
</ul>

<h3 id="package-it-up">Package it up</h3>

<p>OK, so here’s what we’re going to do. You can just take this basic idea and build it into your own queries in your application code. Try it. You might like it. Play around with what fields are affected, how much weight to give it, etc.</p>

<p>But heck, we’ve gone this far. Let’s encode it into the Solr configuration file <code>solrconfig.xml</code> itself as a custom request handler.</p>

<p>We’re going to extend our <code>edismaxplus</code> requestHandler from <a href="http://robotlibrarian.billdueber.com/using-localparams-in-solr-sst-2/">last time</a>, but we’ll add an extra boost query that reflects this new “prefer documents where all the tokens appear in the same ‘line’ of a multiValued query” attitude.</p>

<p><strong>solr/conf/solrconfig.xml</strong></p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#070;font-weight:bold">&lt;requestHandler</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/edismaxplus</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.SearchHandler</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;lst</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">defaults</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;str</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">rows</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>10<span style="color:#070;font-weight:bold">&lt;/str&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;str</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">fl</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>*,score<span style="color:#070;font-weight:bold">&lt;/str&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;str</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">echoParams</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>explicit<span style="color:#070;font-weight:bold">&lt;/str&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;str</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">q</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
      _query_:&quot;{!edismax qf=$fields mm=$mymm
                          v=$qwords bq=$boostForAll}&quot;<span style="color:#070;font-weight:bold">&lt;/str&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;str</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">mymm</span><span style="color:#710">'</span></span><span style="color:#070;font-weight:bold">&gt;</span>0%<span style="color:#070;font-weight:bold">&lt;/str&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;str</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">qwordsphrase</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>&quot;JunkThatWillNEverShowUpInAMillionFreakinYears&quot;<span style="color:#070;font-weight:bold">&lt;/str&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;str</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">boostForAll</span><span style="color:#710">'</span></span><span style="color:#070;font-weight:bold">&gt;</span>
      _query_:&quot;{!edismax qf=$fields
                         mm='100%'
                         v=$qwords }&quot;^5 OR
      _query_:&quot;{!dismax  qf=$fields
                         mm='100%'
                         v=$qwordsphrase
                         qs='999'}&quot;^5
    <span style="color:#070;font-weight:bold">&lt;/str&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/lst&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/requestHandler&gt;</span>  

</pre></div>
</div>
</div>

<p>We now do a few new things:</p>

<ul>
  <li>(<em>Line 15</em>) Add a second clause to the boost query that use the same fields provided for the regular query (note the boolean OR between the two localparams queries that comprise this boost query)</li>
  <li>(<em>Line 17</em>) Ask for another user-provided value: <code>qwordsphrase</code> which your application-level stuff should set to the set of all the regular query ters, but as a single phrase. Basically, strip out all the double-quotes, then put the whole thing in double quotes. In ruby: <code>qwordsphrase = '"' + qwords.gsub(/"/, '"') + '"'</code></li>
  <li>(<em>Line 10</em>) Provide a default value for the new <code>qwordsphrase</code> that won’t ever show up in a real query (empty string won’t work; I tried it and it throws an error). So, if the application doesn’t provide <code>qwordsphrase</code>, no harm is done – the search regresses to what we had last time.</li>
  <li>(<em>Line 18</em>) Use a <code>qs</code> (query slop) of 999 in the new boost clause acting against <code>qwordsphrase</code>. That value is one less than the <code>positionIncrementGap</code> of 1000, making sure that we don’t cross multiValue boundaries.</li>
</ul>

<p><strong>Note</strong>: If you wanted to, you could make this a filter query (<code>fq</code>) instead of a boost query to <em>only</em> allow documents that meet this criterion.</p>

<h3 id="lets-try-it-out">Let’s try it out!</h3>

<p>Once again, if you did a <code>git pull origin master</code> you’ve got this up and running already – the updated requestHandler source is already in <code>solr/conf/solrconfig.xml</code>.</p>

<p>We first construct the query just like we did last week, without the <code>qwordsphrase</code> argument:</p>

<p><a href="http://localhost:8983/solr/edismaxplus/?qwords=davy%20jones&amp;fields=name_text">http://localhost:8983/solr/edismaxplus/?qwords=davy jones&amp;fields=name_text</a></p>

<p>You’ll see Davy Crockett and friend appear as the first item.</p>

<p>But when you add the phraseified query, you’ll see the boost we’ve been talking about this whole post and get something more expected.</p>

<p><a href="http://localhost:8983/solr/edismaxplus/?qwords=davy%20jones&amp;fields=name_text&amp;qwordsphrase=%22Davy%20Jones%22">http://localhost:8983/solr/edismaxplus/?qwords=davy jones&amp;fields=name_text&amp;qwordsphrase=”Davy Jones”</a></p>

<p>The Monkees are again on top! Party like it’s 1967!</p>

<h3 id="where-it-breaks-down">Where it breaks down</h3>

<p>If you actually have a phrase as one of your query terms, it will no longer be treated as a phrase during the boost because we’re getting rid of all the double-quotes.</p>

<p>And, of course, if you’ve got gobs of full-text and include your fulltext field, setting  query slop to 999 isn’t just a cute trick, it’s a cute trick that will melt your servers to slag and still not do what you want it to do.</p>

<h3 id="what-have-we-learned">What have we learned?</h3>

<ul>
  <li>Solr doesn’t really separate multiple values from each other in a <code>multiValued</code> field</li>
  <li>Phrase slop (<code>ps</code>) and query slop (<code>qs</code>) can be used to allow “phrase” to mean “a bunch of tokens within X spots of each other”</li>
  <li><em>I’m A Believer</em> is the best song Neil Diamond ever wrote.</li>
</ul>


        </div>
      </li>
    
      <li>


        <div class="post-text">
          <h2 class="post-title">
            <a class="post-link" href="/2012/03/using-localparams-in-solr-sst-2/">Using localparams in Solr (or, how to boost records that contain all terms) (SST #2)</a>
          </h2>
          <div class="post-meta">Mar 6, 2012</div>
          <p>[Note: this isn’t so much a <em>Stupid Solr Trick</em> as a <em>Thing You Should Probably Know</em>; consider it required reading for the next SST. If you’re just joining us, check out the <a href="http://robotlibrarian.billdueber.com/stupid-solr-tricks-introduction/">introduction to the Stupid Solr Tricks series</a>]</p>

<h3 id="what-the-heck-is-a-localparams-query">What the heck is a localparams query?</h3>

<p>A garden-variety Solr query URL looks something like this:</p>

<pre><code>  http://localhost:8983/solr/select?
    defType=dismax
    &amp;amp;qf=name^2 place^1
    &amp;amp;q=Dueber
</code></pre>

<p>Which is fine, as far as it goes. But it’s easy to run into the limits of the standard query plugins (e.g., Dismax).</p>

<p>Say, for example, you want something like this:</p>

<pre><code>  title:Constructivism AND author:Dueber
</code></pre>

<p>And furthermore, you have multiple underlying fields (title1, title2, title3, author1, author2).</p>

<p>The naïve approach would be to just do this:</p>

<pre><code>  defType=dismax
  &amp;amp;qf=title1 title2 title3 author1 author2
  &amp;amp;q=Constructivism Dueber
</code></pre>

<p>But you can’t construct a dismax query with the boolean AND. You can with edismax, but even then you’ve got no way of telling (e)dismax that <em>Constructivism</em> must be found in the title fields, and <em>Dueber</em> must be found in the author fields. Dismax doesn’t do that.</p>

<h3 id="solution-build-a-query-of-queries">Solution: Build a query of queries</h3>

<p>The solution is to build a query made up of fully-encapsulated sub-queries. A localparams query has two forms (note that, of course, you’d need to URL-Escape the values):</p>

<pre><code>  _query_:"{!dismax qf='field^2 otherfield^4'}my search terms"
or
  _query_:"{!dismax qf='field^2 otherfield^4' v=$q1}" &amp; q1=my search terms
</code></pre>

<p>I far prefer the second form (which uses a second URL parameter <code>q1</code> instead of sticking the search right in there), because I don’t have to worry about escaping double-quotes in the query terms (as you would if there’s a phrase as part of the query).</p>

<p>Once you’ve got these things, you can combine them with booleans.</p>

<pre><code>    q=_query_:"{!dismax qf='title1 title2 title3' v=$q1}" AND
      _query_:"{!dismax qf='author1 author2' v=$q2}"
  &amp;q1=Constructivism
  &amp;q2=Dueber
</code></pre>

<p>[Note: <strong><a href="http://robotlibrarian.billdueber.com/solr-and-boolean-operators/">be careful with solr booleans!!!</a></strong>]</p>

<p>You can add any <em>local parameters</em> you need (for dismax, stuff like mm, qs, pf, and ps) and you can use any query parser you want by changing what comes after the bang (e.g., <code>{!lucene ...}</code> or <code>{!edismax...}</code>).</p>

<p>In this way, you can build up arbitrarily complex queries using any available query parsers in combination with each other. Very powerful.</p>

<h3 id="an-example-boost-records-that-contain-all-terms">An example: boost records that contain all terms</h3>

<p>Just about everything in a localparams query can be pulled out in the way I pulled out the search terms above. Here’s a fairly-complex example (which, let’s be honest, would be a lot more complex if you were trying to inline and escape everything).</p>

<p><strong>Scenario</strong>: We want to do a logical-OR search (mm=0%), but want to make sure we boost documents that contain all the search terms. This is necessary because sometimes a very long document with all the terms will have a lower score than a very short document with most of the terms.</p>

<p>Having short document with a few keywords show up before long documents with all the keywords will drive your librarians <em>CraZy</em>!!! So it’s tempting to just leave it alone. But let’s fix it anyway.</p>

<p>The gist of it is as follows:</p>

<ul>
  <li>Query against title and author</li>
  <li>Use an mm of 0% (logical OR) for the main query</li>
  <li>Use a pf to boost on a phrase in those same two fields (just common sense)</li>
  <li>Set up a boost query (bq) to boost the score if <em>all</em> the search terms are present</li>
</ul>

<p>To accomplish this, we’re going to have two localparams queries: one to be the main query, and another that we’re going to use as the boost query. This works in much the same way as our previous “AND-together two localparams queries” did.</p>

<p>[Presenting the URL parameters as a ruby hash to make it easier to read]</p>

<div><div class="CodeRay">
  <div class="code"><pre>  {
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">q</span><span style="color:#710">'</span></span>=&gt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">_query_:&quot;{!dismax qf=$f1 mm=$mm1 pf=$f1 bq=$bq1 v=$q1}&quot;</span><span style="color:#710">'</span></span>,
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">mm1</span><span style="color:#710">'</span></span>=&gt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">0%</span><span style="color:#710">'</span></span>,
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">f1</span><span style="color:#710">'</span></span>=&gt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">author^3 title^1</span><span style="color:#710">'</span></span>,
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">q1</span><span style="color:#710">'</span></span>=&gt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Dueber Constructivism</span><span style="color:#710">'</span></span>,
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">bq1</span><span style="color:#710">'</span></span>=&gt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">_query_:&quot;{!dismax qf=$f1 mm=</span><span style="color:#b0b">\'</span><span style="color:#D20">100%</span><span style="color:#b0b">\'</span><span style="color:#D20"> v=$q1 }&quot;^5</span><span style="color:#710">'</span></span>,
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">fl</span><span style="color:#710">'</span></span> =&gt;; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">score,*</span><span style="color:#710">'</span></span>
  }


</pre></div>
</div>
</div>

<p>What’s nice about this is that I’m reusing the search terms (for the main query and the boost query) and field list (for the query field and the phrase fields) so I don’t have to repeat them.</p>

<h3 id="try-along-at-home">Try along at home</h3>

<p>First off, if you don’t have a browser that does nice XML and JSON formatting, well, get one. I use Chrome with <a href="https://chrome.google.com/webstore/detail/chklaanhfefbnpoihckbnefhakgolnmc">JSONView</a> and <a href="https://chrome.google.com/webstore/detail/gbammbheopgpmaagmckhpjbfgdfkpadb">XMLTree</a>, but I’m sure there are equivalents for Firefox. They’ll make your life easier.</p>

<p>By now you know the drill:</p>

<div><div class="CodeRay">
  <div class="code"><pre>  cd solr_stupid_tricks
  git pull origin master
  git fetch origin master
  git checkout SST2 # I've started tagging the repo for these posts
  # ignore warning about &quot;detached HEAD&quot;
  java -jar start.jar &amp;
</pre></div>
</div>
</div>

<p>We’ll want to empty out the index and put in some documents to work with. I’m presuming you have <code>curl</code> installed. If not…well, you’re on your own.</p>

<div><div class="CodeRay">
  <div class="code"><pre>  cd exampledocs
  ./reset_and_index_json localparams.json
</pre></div>
</div>
</div>

<p>You might want to take a look at the <code>localparams.json</code> file, which contains a set of documents in the new JSON update structure. The <a href="http://wiki.apache.org/solr/UpdateJSON">full Solr JSON Update structure</a> allows repeated keys. Apparently, so does the <a href="http://www.ietf.org/rfc/rfc4627">JSON RFC</a>:</p>

<blockquote>
  <p>2.2. Objects</p>
</blockquote>

<blockquote>
  <p>An object structure is represented as a pair of curly brackets surrounding zero or more name/value pairs (or members). A name is a string. A single colon comes after each name, separating the name from the value. A single comma separates a value from a following name. <strong>The names within an object SHOULD be unique.</strong> <em>(emphasis mine)</em></p>
</blockquote>

<p>“SHOULD”. Not “MUST”. I don’t care if it’s legal. It still weirds me out.</p>

<p>Once you’ve got solr running in the background, you can go ahead and try our query!</p>

<ul>
  <li>If you’re really lazy, just <a href="http://localhost:8983/solr/select/?q=\_query\_%3A%22%7B%21dismax+qf%3D%24f1+mm%3D%24mm1+pf%3D%24f1+bq%3D%24bq1+v%3D%24q1%7D%22&amp;mm1=0%25&amp;f1=author%5E3+title%5E1&amp;q1=Dueber+Constructivism&amp;bq1=\_query\_%3A%22%7B%21dismax+qf%3D%24f1+mm%3D%27100%25%27+v%3D%24q1+%7D%22%5E5&amp;fl=score%2C%2A">click the link</a></li>
  <li>If you’re slightly less lazy, and you’ve got ruby installed, take a look in the new ruby directory. You can run <code>ruby browse.rb localparams_query.rb</code> to run the query and have it automatically open up in your browser.</li>
  <li>If you’re ambitious, you might want to actually mess with the <code>localparams_query.rb</code> file so you can try things out.</li>
</ul>

<p>As a longish side note, we’ll probably use <code>browse.rb</code> in the future of this series as well, so you might want to go ahead and get ruby installed if you don’t already. <a href="https://rvm.beginrescueend.com/">RVM</a> is the easiest route if you’re on linux/OSX. You can also just install <a href="http://jruby.org/">JRuby</a>, seeing as how you’re running java anway (just make sure to use 1.9 mode by calling stuff as <code>jruby --1.9 myscript.rb</code> or setting the environment variable <code>export JRUBY_OPTS=--1.9</code>).</p>

<h3 id="special-stupid-solr-trick-make-a-special-query-handler-for-a-complex-query">Special Stupid Solr Trick: Make a special query handler for a complex query</h3>

<p>OK, so I said I wouldn’t have a real SST in this episode, but it’s so damn long at this point I figure I’ve lost everyone except Rochkind (Hey, Jonathan!), so let’s throw one in.</p>

<p>The Solr configuration file <code>solrconfig.xml</code> is where you can configure custom search handlers. In such a custom handler, you can specify defaults (which, by default, can be overridden by passed-in parameters, although you can control that, too) – this is commonly used to, say, put in a <code>q.alt</code> or a filter query that will always be applied.</p>

<p>But we can use it to put in our special query defaults that boosts when a document contains all the terms:</p>

<div><div class="CodeRay">
  <div class="code"><pre>

      10
      *,score
      explicit

        _query_:&quot;{!edismax qf=$fields
                           mm=$mymm
                           v=$qwords
                           bq=$boostForAll}&quot;

      0%

        _query_:&quot;{!edismax qf=$fields
                           mm='100%'
                           v=$qwords }&quot;^5
</pre></div>
</div>
</div>

<p>If you look closely, you’ll see that everything you need is defined in this requestHandler in the <code>solrconfig.xml</code> file, except for <code>$fields</code> and <code>$qwords</code>. You could also override <code>mymm</code> by passing in an argument with that name, if the default ‘0%’ isn’t to your liking.</p>

<p>If you’ve been following along at home, this requestHandler is already in the <code>solrconfig.xml</code> file that you’re running right now. Go ahead and try it! Let’s search for the terms ‘dueberb’ and ‘penn’ and see if the correct record floats to the top.</p>

<p><a href="http://localhost:8983/solr/edismaxplus/?qwords=dueber%20penn&amp;fields=author%20title">http://localhost:8983/solr/edismaxplus/?qwords=dueber penn&amp;fields=author title</a></p>

<p>Nifty, huh?</p>

<p>Next time we’ll use a local params query to get around something about dismax that drives me crazy: preventing (or penalizing) matches that go across a field’s multiple values.100%<br />
What’s nice about this is that I’m reusing the search terms (for the main query and the boost query) and field list (for the query field and the phrase fields) so I don’t have to repeat them.</p>

<h3 id="try-along-at-home-1">Try along at home</h3>

<p>First off, if you don’t have a browser that does nice XML and JSON formatting, well, get one. I use Chrome with <a href="https://chrome.google.com/webstore/detail/chklaanhfefbnpoihckbnefhakgolnmc">JSONView</a> and <a href="https://chrome.google.com/webstore/detail/gbammbheopgpmaagmckhpjbfgdfkpadb">XMLTree</a>, but I’m sure there are equivalents for Firefox. They’ll make your life easier.</p>

<p>By now you know the drill:</p>

<div><div class="CodeRay">
  <div class="code"><pre>  cd solr_stupid_tricks
  git pull origin master
  git fetch origin master
  git checkout SST2 # I've started tagging the repo for these posts
  # ignore warning about &quot;detached HEAD&quot;
  java -jar start.jar &amp;amp;
</pre></div>
</div>
</div>
<p>We’ll want to empty out the index and put in some documents to work with. I’m presuming you have <code>curl</code> installed. If not…well, you’re on your own.</p>

<div><div class="CodeRay">
  <div class="code"><pre>  cd exampledocs
  ./reset_and_index_json localparams.json
</pre></div>
</div>
</div>
<p>You might want to take a look at the <code>localparams.json</code> file, which contains a set of documents in the new JSON update structure. The <a href="http://wiki.apache.org/solr/UpdateJSON">full Solr JSON Update structure</a> allows repeated keys. Apparently, so does the <a href="http://www.ietf.org/rfc/rfc4627">JSON RFC</a>:</p>

<p>&gt; 2.2. Objects
&gt; An object structure is represented as a pair of curly brackets
&gt; surrounding zero or more name/value pairs (or members). A name is a
&gt; string. A single colon comes after each name, separating the name
&gt; from the value. A single comma separates a value from a following
&gt; name. <strong>The names within an object SHOULD be unique.</strong> <em>(emphasis mine)</em></p>

<p>“SHOULD”. Not “MUST”. I don’t care if it’s legal. It still weirds me out.</p>

<p>Once you’ve got solr running in the background, you can go ahead and try our query!</p>

<ul>
  <li>If you’re really lazy, just <a href="http://localhost:8983/solr/select/?q=\_query\_%3A%22%7B%21dismax+qf%3D%24f1+mm%3D%24mm1+pf%3D%24f1+bq%3D%24bq1+v%3D%24q1%7D%22&amp;mm1=0%25&amp;f1=author%5E3+title%5E1&amp;q1=Dueber+Constructivism&amp;bq1=\_query\_%3A%22%7B%21dismax+qf%3D%24f1+mm%3D%27100%25%27+v%3D%24q1+%7D%22%5E5&amp;fl=score%2C%2A">click the link</a></li>
  <li>If you’re slightly less lazy, and you’ve got ruby installed, take a look in the new ruby directory. You can run <code>ruby browse.rb localparams_query.rb</code> to run the query and have it automatically open up in your browser.</li>
  <li>If you’re ambitious, you might want to actually mess with the <code>localparams_query.rb</code> file so you can try things out.</li>
</ul>

<p>As a longish side note, we’ll probably use <code>browse.rb</code> in the future of this series as well, so you might want to go ahead and get ruby installed if you don’t already. <a href="https://rvm.beginrescueend.com/">RVM</a> is the easiest route if you’re on linux/OSX. You can also just install <a href="http://jruby.org/">JRuby</a>, seeing as how you’re running java anway (just make sure to use 1.9 mode by calling stuff as <code>jruby --1.9 myscript.rb</code> or setting the environment variable <code>export JRUBY_OPTS=--1.9</code>).</p>

<h3 id="special-stupid-solr-trick-make-a-special-query-handler-for-a-complex-query-1">Special Stupid Solr Trick: Make a special query handler for a complex query</h3>

<p>OK, so I said I wouldn’t have a real SST in this episode, but it’s so damn long at this point I figure I’ve lost everyone except Rochkind (Hey, Jonathan!), so let’s throw one in.</p>

<p>The Solr configuration file <code>solrconfig.xml</code> is where you can configure custom search handlers. In such a custom handler, you can specify defaults (which, by default, can be overridden by passed-in parameters, although you can control that, too) – this is commonly used to, say, put in a <code>q.alt</code> or a filter query that will always be applied.</p>

<p>But we can use it to put in our special query defaults that boosts when a document contains all the terms:</p>

<div><div class="CodeRay">
  <div class="code"><pre>

      10
      *,score
      explicit

        _query_:&quot;{!edismax qf=$fields
                           mm=$mymm
                           v=$qwords
                           bq=$boostForAll}&quot;

      0%

        _query_:&quot;{!edismax qf=$fields
                           mm='100%'
                           v=$qwords }&quot;^5
</pre></div>
</div>
</div>
<p>If you look closely, you’ll see that everything you need is defined in this requestHandler in the <code>solrconfig.xml</code> file, except for <code>$fields</code> and <code>$qwords</code>. You could also override <code>mymm</code> by passing in an argument with that name, if the default ‘0%’ isn’t to your liking.</p>

<p>If you’ve been following along at home, this requestHandler is already in the <code>solrconfig.xml</code> file that you’re running right now. Go ahead and try it! Let’s search for the terms ‘dueberb’ and ‘penn’ and see if the correct record floats to the top.</p>

<p><a href="http://localhost:8983/solr/edismaxplus/?qwords=dueber%20penn&amp;fields=author%20title">http://localhost:8983/solr/edismaxplus/?qwords=dueber penn&amp;fields=author title</a></p>

<p>Nifty, huh?</p>

<p>Next time we’ll use a local params query to get around something about dismax that drives me crazy: preventing (or penalizing) matches that go across a field’s multiple values. v=$q1 }”^5’,<br />
  ‘fl’ =&gt; ‘score,*’<br />
  }<br />
~~~<br />
What’s nice about this is that I’m reusing the search terms (for the main query and the boost query) and field list (for the query field and the phrase fields) so I don’t have to repeat them.</p>

<h3 id="try-along-at-home-2">Try along at home</h3>

<p>First off, if you don’t have a browser that does nice XML and JSON formatting, well, get one. I use Chrome with <a href="https://chrome.google.com/webstore/detail/chklaanhfefbnpoihckbnefhakgolnmc">JSONView</a> and <a href="https://chrome.google.com/webstore/detail/gbammbheopgpmaagmckhpjbfgdfkpadb">XMLTree</a>, but I’m sure there are equivalents for Firefox. They’ll make your life easier.</p>

<p>By now you know the drill:</p>

<div><div class="CodeRay">
  <div class="code"><pre>  cd solr_stupid_tricks
  git pull origin master
  git fetch origin master
  git checkout SST2 # I've started tagging the repo for these posts
  # ignore warning about &quot;detached HEAD&quot;
  java -jar start.jar &amp;amp;
</pre></div>
</div>
</div>
<p>We’ll want to empty out the index and put in some documents to work with. I’m presuming you have <code>curl</code> installed. If not…well, you’re on your own.</p>

<div><div class="CodeRay">
  <div class="code"><pre>  cd exampledocs
  ./reset_and_index_json localparams.json
</pre></div>
</div>
</div>
<p>You might want to take a look at the <code>localparams.json</code> file, which contains a set of documents in the new JSON update structure. The <a href="http://wiki.apache.org/solr/UpdateJSON">full Solr JSON Update structure</a> allows repeated keys. Apparently, so does the <a href="http://www.ietf.org/rfc/rfc4627">JSON RFC</a>:</p>

<p>&gt; 2.2. Objects
&gt; An object structure is represented as a pair of curly brackets
&gt; surrounding zero or more name/value pairs (or members). A name is a
&gt; string. A single colon comes after each name, separating the name
&gt; from the value. A single comma separates a value from a following
&gt; name. <strong>The names within an object SHOULD be unique.</strong> <em>(emphasis mine)</em></p>

<p>“SHOULD”. Not “MUST”. I don’t care if it’s legal. It still weirds me out.</p>

<p>Once you’ve got solr running in the background, you can go ahead and try our query!</p>

<ul>
  <li>If you’re really lazy, just <a href="http://localhost:8983/solr/select/?q=\_query\_%3A%22%7B%21dismax+qf%3D%24f1+mm%3D%24mm1+pf%3D%24f1+bq%3D%24bq1+v%3D%24q1%7D%22&amp;mm1=0%25&amp;f1=author%5E3+title%5E1&amp;q1=Dueber+Constructivism&amp;bq1=\_query\_%3A%22%7B%21dismax+qf%3D%24f1+mm%3D%27100%25%27+v%3D%24q1+%7D%22%5E5&amp;fl=score%2C%2A">click the link</a></li>
  <li>If you’re slightly less lazy, and you’ve got ruby installed, take a look in the new ruby directory. You can run <code>ruby browse.rb localparams_query.rb</code> to run the query and have it automatically open up in your browser.</li>
  <li>If you’re ambitious, you might want to actually mess with the <code>localparams_query.rb</code> file so you can try things out.</li>
</ul>

<p>As a longish side note, we’ll probably use <code>browse.rb</code> in the future of this series as well, so you might want to go ahead and get ruby installed if you don’t already. <a href="https://rvm.beginrescueend.com/">RVM</a> is the easiest route if you’re on linux/OSX. You can also just install <a href="http://jruby.org/">JRuby</a>, seeing as how you’re running java anway (just make sure to use 1.9 mode by calling stuff as <code>jruby --1.9 myscript.rb</code> or setting the environment variable <code>export JRUBY_OPTS=--1.9</code>).</p>

<h3 id="special-stupid-solr-trick-make-a-special-query-handler-for-a-complex-query-2">Special Stupid Solr Trick: Make a special query handler for a complex query</h3>

<p>OK, so I said I wouldn’t have a real SST in this episode, but it’s so damn long at this point I figure I’ve lost everyone except Rochkind (Hey, Jonathan!), so let’s throw one in.</p>

<p>The Solr configuration file <code>solrconfig.xml</code> is where you can configure custom search handlers. In such a custom handler, you can specify defaults (which, by default, can be overridden by passed-in parameters, although you can control that, too) – this is commonly used to, say, put in a <code>q.alt</code> or a filter query that will always be applied.</p>

<p>But we can use it to put in our special query defaults that boosts when a document contains all the terms:</p>

<div><div class="CodeRay">
  <div class="code"><pre>

      10
      *,score
      explicit

        _query_:&quot;{!edismax qf=$fields
                           mm=$mymm
                           v=$qwords
                           bq=$boostForAll}&quot;

      0%

        _query_:&quot;{!edismax qf=$fields
                           mm='100%'
                           v=$qwords }&quot;^5
</pre></div>
</div>
</div>
<p>If you look closely, you’ll see that everything you need is defined in this requestHandler in the <code>solrconfig.xml</code> file, except for <code>$fields</code> and <code>$qwords</code>. You could also override <code>mymm</code> by passing in an argument with that name, if the default ‘0%’ isn’t to your liking.</p>

<p>If you’ve been following along at home, this requestHandler is already in the <code>solrconfig.xml</code> file that you’re running right now. Go ahead and try it! Let’s search for the terms ‘dueberb’ and ‘penn’ and see if the correct record floats to the top.</p>

<p><a href="http://localhost:8983/solr/edismaxplus/?qwords=dueber%20penn&amp;fields=author%20title">http://localhost:8983/solr/edismaxplus/?qwords=dueber penn&amp;fields=author title</a></p>

<p>Nifty, huh?</p>

<p>Next time we’ll use a local params query to get around something about dismax that drives me crazy: preventing (or penalizing) matches that go across a field’s multiple values.</p>


        </div>
      </li>
    
      <li>


        <div class="post-text">
          <h2 class="post-title">
            <a class="post-link" href="/2012/03/solr-field-type-for-numericish-ids/">Solr Field Type for numeric(ish) IDs (SST #1)</a>
          </h2>
          <div class="post-meta">Mar 1, 2012</div>
          <p>[For the introduction to this series, take a quick gander at <a href="http://robotlibrarian.billdueber.com/stupid-solr-tricks-introduction/">the introduction</a>]</p>

<p>Like everyone else in the library world, I’ve got a bunch of well-defined, well-controlled standard identifiers I need to keep track of and allow searching on.</p>

<p>You know, well-vetted stuff like this:</p>

<ul>
  <li>1234-5678</li>
  <li>123-4567-890</li>
  <li>12-34-567-X</li>
  <li>0012-0045</li>
  <li>ISBN13: 1234567890123</li>
  <li>ISSN: 1234567X (1998-99)</li>
  <li>ISSN (1998-99): 1234567X</li>
  <li>1234567890 (hdk. 22 pgs)</li>
  <li>9</li>
  <li>Behind the 3rd floor desk</li>
  <li>Henry VIII</li>
</ul>

<p>[Note: some of these may be a titch exaggerated]</p>

<p>How does your system deal with these on index? How about on query?</p>

<p>Here’s an idea of how to use a custom solr fieldtype to do the heavy lifting.</p>

<h3 id="what-were-shooting-for">What we’re shooting for</h3>

<p>I’d like to be able to send in a text string as follows:</p>

<ul>
  <li>The input can contain other text besides the id</li>
  <li>The ID starts with a digit and consists solely of digits and (optional) dashes, then ends with a digits and possibly a trailing ‘X’ or ‘x’ so we can deal with ISBN/ISSN</li>
  <li>The ID has to be at least N characters long (for this example, I’m using N=8); this helps us avoid other text that might trivially look like an ID but isn’t.</li>
  <li>Only the ID itself is indexed</li>
  <li>If no valid ID is identified, nothing is indexed</li>
</ul>

<h3 id="the-numericid-field-suitable-for-isbnissnoclcetc">The numericID field, suitable for ISBN/ISSN/OCLC/etc.</h3>

<p>Let’s take a look at the end product and then walk through it.</p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#070;font-weight:bold">&lt;fieldtype</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">numericID</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.TextField</span><span style="color:#710">&quot;</span></span>
           <span style="color:#b48">positionIncrementGap</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">1000</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">omitNorms</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">true</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
<span style="color:#070;font-weight:bold">&lt;analyzer&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;tokenizer</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.KeywordTokenizerFactory</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.PatternReplaceFilterFactory</span><span style="color:#710">&quot;</span></span>
              <span style="color:#b48">pattern</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">^.*?(\p{N}[\p{N}\-\.]{6,}[xX]?).*$</span><span style="color:#710">&quot;</span></span>
              <span style="color:#b48">replacement</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">***$1</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.PatternReplaceFilterFactory</span><span style="color:#710">&quot;</span></span>
              <span style="color:#b48">pattern</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">^[^\*].*$</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">replacement</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.PatternReplaceFilterFactory</span><span style="color:#710">&quot;</span></span>
              <span style="color:#b48">pattern</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">^\*\*\*</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">replacement</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.LowerCaseFilterFactory</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.PatternReplaceFilterFactory</span><span style="color:#710">&quot;</span></span>
              <span style="color:#b48">pattern</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">[^\p{N}x]</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">replacement</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>
              <span style="color:#b48">replace</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">all</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.LengthFilterFactory</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">min</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">8</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">max</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">14</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;filter</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">solr.PatternReplaceFilterFactory</span><span style="color:#710">&quot;</span></span>
              <span style="color:#b48">pattern</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">^0*</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">replacement</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>
    <span style="color:#070;font-weight:bold">/&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/analyzer&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/fieldtype&gt;</span>
</pre></div>
</div>
</div>

<h3 id="things-well-be-learning-about-today">Things we’ll be learning about today</h3>

<p><strong>NOTE: I really, really recommend taking a look at <a href="http://www.lucidimagination.com/content/scaling-lucene-and-solr">Scaling Lucene and Solr</a> by the good folks over at <a href="http://www.lucidimagination.com/">Lucid Imagination</a> for great, short explanations of <em>omitNorms</em>, term frequencies, etc.</strong></p>

<p>Since this is the first post, I’ll go over some stuff that’s probably a little<br />
too basic for any audience that’s likely to show up here, but what the heck.</p>

<ul>
  <li>KeywordTokenizer</li>
  <li>PatternReplaceFilterFactory</li>
  <li>LowerCaseFilterFactory</li>
  <li>LengthFilterFactory</li>
</ul>

<h4 id="step-1-tokenize-to-a-single-token">Step 1: “Tokenize” to a single token</h4>

<p>The job of a <em>tokenizer</em> is to decide how to split your input into individual tokens (often “words”), which are then munged by any filters you’re applying.</p>

<p>For the case of an ID, <em>we don’t want to tokenize</em>. At least at this juncture, I’m not trying to extract multiple valid IDs out of a single string; I’m just trying to determine if there’s a valid ID in there somewhere and throwing everything else away.</p>

<p>In other words, I’m going to treat the input as a <em>single token</em>, and then munge the bejeebers out of it in order to get what I want.</p>

<p>In the Solr world, that leads us to the confusingly-named <a href="http://wiki.apache.org/solr/AnalyzersTokenizersTokenFilters#solr.KeywordTokenizerFactory">KeywordTokenizer</a>.</p>

<p><strong>What we have now</strong>: exactly what we started with</p>

<h4 id="step-2-find-the-first-thing-that-looks-like-an-id-and-mark-it">Step 2: Find the first thing that looks like an ID and mark it</h4>

<p>I primarily work in Ruby and Perl, which means the dramatic abuse of regular expressions is just part of my daily life.</p>

<p>Line 5 is our first use of a regexp in the filter chain via <a href="http://wiki.apache.org/solr/AnalyzersTokenizersTokenFilters#solr.PatternReplaceFilterFactory">PatternReplaceFilterFactory</a>.</p>

<p>The idea is to:</p>

<ol>
  <li>Find something that looks like a match</li>
  <li>If found, get rid of everything else, and throw a ‘***’ onto the beginning so later on I can tell if I matched or not.</li>
</ol>

<p>The second step is a little…odd…but necessary because I need a way to know if I found a candidate ID or not. If I did, well, there will be three asterisks on the front of the string from here on out. If not, there won’t.</p>

<p>This is a little confusing as these things go, so I’ll break it down.</p>

<p>Line 6: the match:</p>

<ul>
  <li>Skip any amount of stuff we don’t care about (.*?)</li>
  <li>Match a number (\p{N}) (that’s unicode regexp syntax, if you haven’t seen it)</li>
  <li>Match a string of at least 6 numbers and dashes</li>
  <li>Close with an optional X or x [Xx]?</li>
  <li>…and any trailing bits until the end of the string.</li>
</ul>

<p>So…<em>[number][six numbers/dashes][optional X]</em></p>

<p>At minimum, that’s seven digits/dashes.</p>

<p>Line 7: replacement</p>

<ul>
  <li>Replace the whole string (note how I anchored the match with ^ and $?) with whatever was matched inside the parentheses (represented here by $1) after prepending a set of three asterisks ‘***’</li>
</ul>

<p><strong>What we have now</strong>: If we found a candidate ID, we have that string prepended by ‘***’. Otherwise, we have exactly what we started with.</p>

<h4 id="step-3-if-we-didnt-find-a-match-throw-it-all-away">Step 3: If we didn’t find a match, throw it all away</h4>

<p>Line 9 shows an attempt to match on any string that start with an asterisk (which we’re pretty sure we won’t see because that’s illegal lucene wildcard syntax). If we have a string that doesn’t start with an asterisk, then throw the whole damn thing away because we don’t have a candidate ID anyway.</p>

<p>[There’s a strong argument to be made that using an asterisk as the tagging character is a bad choice. Anyone have suggestions?]</p>

<p><strong>What we have now</strong>: Either a candidate ID string preceded by ‘***’ or the empty string.</p>

<h4 id="step-4-ditch-the--used-to-mark-a-candidate-id">Step 4: Ditch the ‘***’ used to mark a candidate ID</h4>

<p>Lines 10-11</p>

<p>Find the ‘***’ and throw it away.</p>

<p><strong>What we have now</strong>: The raw candidate ID string or the empty string.</p>

<h4 id="step-5-lowercase-it">Step 5: Lowercase it</h4>

<p>Line 12.</p>

<p>By ‘it’ I mean “any X that might be trailing the ID”; we should have thrown everything else away by now. (Note: could have done this with a PattenReplace as well, obviously; not sure why’d I’d choose one over the other).</p>

<p><strong>What we have now</strong>: The raw candidate ID string with its optional trailing ‘X’ lowercased, or the empty string</p>

<h4 id="step-6-get-rid-of-everything-thats-not-a-number-or-an-x">Step 6: Get rid of everything that’s not a number or an ‘x’</h4>

<p>Lines 13-15</p>

<p>Ditch any dashes that are remaining. I’m doing it like this instead of just ditching the dashes because I’ll likely modify this at some point to allow, e.g., periods between numbers, or maybe spaces. This is safer.</p>

<p>Note the extra parameter (replace=”all”), indicating that I want to replace all occurrences. This hasn’t been an issue until now because I’ve been careful to match the entire string by anchoring the pattern at the beginning (‘^’) and end (‘$’).</p>

<p><strong>What we have now</strong>: A string of numbers possibly followed by an ‘x’, or the empty string.</p>

<h4 id="step-7-make-sure-what-we-have-is-a-reasonable-length">Step 7: Make sure what we have is a reasonable length</h4>

<p>Line 16</p>

<p>Now that we’ve gotten rid of the dashes, we need to make sure we have enough digits left to make a valid identifier.</p>

<p>If we didn’t match originally, it quickly got reduced to the empty string, and that will disappear here due to having length 0.</p>

<p>It’s also possible that our initial match was, say, ‘1—-3—–6—7’, which will at this point have been reduced to just ‘1367’ – too short for our taste.</p>

<p>In this version, I allow strings of any length between 7 (old OCLC number) and 14 (barcode).</p>

<p><strong>What we have now</strong>: A string consisting purely of 7-14 characters, the last of which may be an ‘x’, or nothing at all (e.g., nothing will get indexed).</p>

<h4 id="step-8-remove-leading-0s">Step 8: Remove leading 0s</h4>

<p>My ILS (Aleph) loves to zero-pad all its local identifiers. I’d rather get rid of them.</p>

<p><strong>What we have now</strong>: What we had before, but with no leading zeros</p>

<h3 id="lets-try-it">Let’s try it!</h3>

<p>If you’re following along at home, get the latest version of the schema and try it!</p>

<div><div class="CodeRay">
  <div class="code"><pre>
  cd solr_stupid_tricks
  git pull origin master
  java -jar start.jar

</pre></div>
</div>
</div>

<p>…and then:</p>

<ul>
  <li>Go to the analysis page at <a href="http://localhost:8983/solr/admin/analysis.jsp?highlight=on">http://localhost:8983/solr/admin/analysis.jsp?highlight=on</a></li>
  <li>Set the first line of the form to use Field: <strong>type</strong> and input <em>numericID</em></li>
  <li>Check the “verbose output” checkbox under <em>Field value: index</em></li>
  <li>Put in a test value and see what the analyzer gives you!</li>
</ul>

<p>For those of you <em>not</em> following along at home, here are the examples from waaaaaay at the top of this post:</p>

<ul>
  <li>1234-5678 =&gt; 12345678</li>
  <li>123-4567-890 =&gt; 1234567890</li>
  <li>12-34-567-X =&gt; 1234567x</li>
  <li>0012-0045 =&gt; 120045</li>
  <li>ISBN13: 1234567890123 =&gt; 1234567890123</li>
  <li>ISSN: 1234567X (1998-99) =&gt; 1234567x</li>
  <li>ISSN (1998-99): 1234567X =&gt; <strong>199899</strong></li>
  <li>1234567890 (hdk. 22 pgs) =&gt; 1234567890</li>
  <li>9 =&gt; [nothing]</li>
  <li>Behind the 3rd floor desk =&gt; [nothing]</li>
  <li>Henry VIII =&gt; [nothing]</li>
</ul>

<p>So…not too bad. We did miss one, mistaking a year range for a numeric ID, but if your data are that bad, there’s only so much we can do.</p>

<h3 id="conclusions">Conclusions</h3>

<p>Obviously, this is the tip of the iceberg with this sort of thing. And it can still be confused.</p>

<p>But it <em>does</em> follow our goal of having the exact same behavior on index and query, moving the logic to solr, and being pretty flexible.</p>

<p>Perfect? No. Useful? Yes.</p>


        </div>
      </li>
    
  </ul>


</div>

        </div>
      </div>
      <div id="sidebar">
        The sidebar
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">

      <div class="footer-col  footer-col-1">
        <ul class="internal_links">
          <li><a href="/feed.xml">RSS Feed</a></li>
          <li>Recent posts</li>
        </ul>
      </div>


      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/billdueber">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">billdueber</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/billdueber">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">billdueber</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Copyright 2008-2014, Bill Dueber</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
